# ç®€åŒ–çš„Pipelineæ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [è®¾è®¡ç†å¿µ](#è®¾è®¡ç†å¿µ)
2. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [ä½¿ç”¨æ–¹æ³•](#ä½¿ç”¨æ–¹æ³•)
5. [ä¸æ—§æ¶æ„å¯¹æ¯”](#ä¸æ—§æ¶æ„å¯¹æ¯”)

---

## ğŸ¯ è®¾è®¡ç†å¿µ

### é—®é¢˜è¯Šæ–­
æ—§æ¶æ„å­˜åœ¨çš„é—®é¢˜ï¼š
- **è¿‡åº¦å¤æ‚**ï¼šQueue + Barrier + Signalæœºåˆ¶éš¾ä»¥ç†è§£å’Œè°ƒè¯•
- **ç±»å‹æ··ä¹±**ï¼šBatchDataæ³›å‹åœ¨stageé—´è½¬æ¢å¤æ‚
- **éš¾ä»¥æ’é”™**ï¼šå¼‚æ­¥æµå¼å¤„ç†å‡ºé”™éš¾å®šä½
- **å†…å­˜é£é™©**ï¼šæ— æ˜ç¡®çš„å†…å­˜ç®¡ç†ç­–ç•¥

### è®¾è®¡åŸåˆ™
æ–°æ¶æ„éµå¾ªçš„åŸåˆ™ï¼š
1. **ç®€å•ä¼˜å…ˆ**ï¼šç”¨æœ€ç®€å•çš„æ–¹å¼å®ç°åŠŸèƒ½
2. **ç±»å‹æ¸…æ™°**ï¼šæ˜ç¡®æ¯ä¸ªstageçš„è¾“å…¥è¾“å‡º
3. **æ˜“äºè°ƒè¯•**ï¼šåŒæ­¥æ‰¹å¤„ç†ï¼Œstep-by-stepå¯è¿½è¸ª
4. **å®¹é”™å®Œå–„**ï¼šå¤±è´¥é‡è¯•ã€é”™è¯¯è®°å½•ã€æ–­ç‚¹ç»­ä¼ 

---

## ğŸ— æ¶æ„æ¦‚è§ˆ

### æ•´ä½“æµç¨‹

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         DataProducer                    â”‚
                    â”‚  - åŠ è½½ç´¢å¼•                              â”‚
                    â”‚  - ç”Ÿæˆæ‰¹æ¬¡                              â”‚
                    â”‚  - ç®¡ç†checkpoint                        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     æ‰¹æ¬¡åˆ—è¡¨ (List[ProcessBatch])        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚        SimplifiedPipeline                   â”‚
            â”‚        æ‰¹å¤„ç†å¾ªç¯è°ƒåº¦å™¨                        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   for stage in stages:  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                          â”‚                          â”‚
        â–¼                          â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage1 Pool   â”‚         â”‚ Stage2 Pool   â”‚         â”‚ Stage3 Pool   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Actor 1 â”‚  â”‚         â”‚  â”‚ Actor 1 â”‚  â”‚         â”‚  â”‚ Actor 1 â”‚  â”‚
â”‚  â”‚ Actor 2 â”‚  â”‚  â”€â”€â”€â”€â–º  â”‚  â”‚ Actor 2 â”‚  â”‚  â”€â”€â”€â”€â–º  â”‚  â”‚ Actor 2 â”‚  â”‚
â”‚  â”‚ Actor 3 â”‚  â”‚         â”‚  â”‚ Actor 3 â”‚  â”‚         â”‚  â”‚ Actor 3 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                          â”‚                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   å¤„ç†å®Œæˆçš„æ‰¹æ¬¡åˆ—è¡¨           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
Records (Dict)  â”€â”€â”€â”€â–º  RawAudio (Dict)  â”€â”€â”€â”€â–º  Tensor (Dict)  â”€â”€â”€â”€â–º  VAD (Dict)  â”€â”€â”€â”€â–º  Segments (Dict)
    â”‚                       â”‚                       â”‚                     â”‚                     â”‚
    file_id                file_id                 file_id               file_id               file_id
    oss_path               audio_bytes             waveform              segments              waveform
    ...                    ...                     sample_rate           vad_result            start_time
                                                                         ...                   ...
```

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. ProcessBatch - ç»Ÿä¸€çš„æ‰¹æ¬¡å®¹å™¨

```python
@dataclass
class ProcessBatch:
    batch_id: str          # æ‰¹æ¬¡ID
    data: Any              # å®é™…æ•°æ®ï¼ˆçµæ´»ç±»å‹ï¼‰
    metadata: Dict         # å…ƒæ•°æ®
    stage: str             # å½“å‰æ‰€åœ¨stage
    retry_count: int       # é‡è¯•æ¬¡æ•°
    error: Optional[str]   # é”™è¯¯ä¿¡æ¯
```

**è®¾è®¡ä¼˜åŠ¿ï¼š**
- ä¸ä½¿ç”¨æ³›å‹ï¼Œé¿å…ç±»å‹å¤æ‚åº¦
- `data`å­—æ®µçµæ´»ï¼Œå¯ä»¥æ˜¯ä»»ä½•ç±»å‹
- å†…ç½®é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

### 2. StageProcessor - StageåŸºç±»

```python
class StageProcessor:
    def __init__(self, config, stage_name):
        pass
    
    def process(self, batch: ProcessBatch) -> ProcessBatch:
        # å­ç±»å®ç°
        raise NotImplementedError
```

**è®¾è®¡ä¼˜åŠ¿ï¼š**
- æ¥å£ç®€å•æ¸…æ™°
- è¾“å…¥è¾“å‡ºéƒ½æ˜¯ProcessBatch
- æ˜“äºå®ç°å’Œæµ‹è¯•

### 3. SimplifiedPipeline - è°ƒåº¦å™¨

```python
class SimplifiedPipeline:
    def setup_producer(self):
        # åˆ›å»ºç”Ÿäº§è€…
    
    def add_stage(self, stage_class, config, name, num_workers):
        # æ·»åŠ stageï¼ˆåˆ›å»ºActorPoolï¼‰
    
    def run(self, max_batches, max_retries):
        # è¿è¡Œpipeline
        batches = producer.load_batches()
        
        for stage in stages:
            # æäº¤æ‰€æœ‰æ‰¹æ¬¡åˆ°ActorPool
            for batch in batches:
                pool.submit(process, batch)
            
            # æ”¶é›†ç»“æœï¼ˆè‡ªåŠ¨è´Ÿè½½å‡è¡¡ï¼‰
            results = []
            while pool.has_next():
                result = pool.get_next()
                if result.error:
                    retry or fail
                else:
                    results.append(result)
            
            batches = results  # ä¼ é€’ç»™ä¸‹ä¸€stage
```

**è®¾è®¡ä¼˜åŠ¿ï¼š**
- ç®€å•çš„forå¾ªç¯ï¼Œæ˜“äºç†è§£
- ActorPoolè‡ªåŠ¨è´Ÿè½½å‡è¡¡
- æ¸…æ™°çš„é”™è¯¯å¤„ç†æµç¨‹

### 4. 4ä¸ªStage Processor

```
AudioDownloadProcessor      è¾“å…¥: List[Dict(file_id, oss_path)]
    â”‚                       è¾“å‡º: List[Dict(file_id, audio_bytes)]
    â”‚
AudioPreprocessingProcessor è¾“å…¥: List[Dict(audio_bytes)]
    â”‚                       è¾“å‡º: List[Dict(waveform, sample_rate)]
    â”‚
VADProcessor                è¾“å…¥: List[Dict(waveform)]
    â”‚                       è¾“å‡º: List[Dict(segments, vad_result)]
    â”‚
SegmentExpansionProcessor   è¾“å…¥: List[Dict(segments)]
                            è¾“å‡º: List[Dict(segmentçº§åˆ«æ•°æ®)]
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬ä½¿ç”¨

```bash
# å¤„ç†æ‰€æœ‰æ•°æ®
python run_simple_pipeline.py --config config.yaml

# æµ‹è¯•æ¨¡å¼ï¼ˆåªå¤„ç†10ä¸ªæ‰¹æ¬¡ï¼‰
python run_simple_pipeline.py --config config.yaml --max-batches 10

# è°ƒæ•´æ—¥å¿—çº§åˆ«
python run_simple_pipeline.py --config config.yaml --log-level DEBUG
```

### 2. æŸ¥çœ‹çŠ¶æ€

```bash
# æŸ¥çœ‹å¤„ç†è¿›åº¦
python run_simple_pipeline.py status

# æ¸…é™¤checkpointé‡æ–°å¼€å§‹
python run_simple_pipeline.py clear-checkpoint --yes
```

### 3. é…ç½®è°ƒæ•´

åœ¨`config.yaml`ä¸­è°ƒæ•´å„stageçš„workeræ•°é‡ï¼š

```yaml
pipeline:
  batch_size: 32
  stage_workers:
    audio_download: 8        # ä¸‹è½½workeræ•°
    audio_preprocessing: 6   # é¢„å¤„ç†workeræ•°
    vad_processing: 4        # VAD workeræ•°
    segment_expansion: 4     # ç‰‡æ®µå±•å¼€workeræ•°
```

---

## ğŸ“Š ä¸æ—§æ¶æ„å¯¹æ¯”

| å¯¹æ¯”é¡¹ | æ—§æ¶æ„ | æ–°æ¶æ„ |
|--------|--------|--------|
| **å¤æ‚åº¦** | é«˜ï¼ˆQueue+Barrier+Signalï¼‰ | ä½ï¼ˆforå¾ªç¯+ActorPoolï¼‰ |
| **è°ƒè¯•éš¾åº¦** | éš¾ï¼ˆå¼‚æ­¥å¤šçº¿ç¨‹ï¼‰ | æ˜“ï¼ˆåŒæ­¥æ‰¹å¤„ç†ï¼‰ |
| **ç±»å‹ç³»ç»Ÿ** | å¤æ‚ï¼ˆBatchDataæ³›å‹ï¼‰ | ç®€å•ï¼ˆProcessBatch+Anyï¼‰ |
| **é”™è¯¯å¤„ç†** | éšå¼ï¼ˆä¿¡å·ä¼ æ’­ï¼‰ | æ˜¾å¼ï¼ˆé‡è¯•æœºåˆ¶ï¼‰ |
| **å†…å­˜ç®¡ç†** | éšå¼ï¼ˆé˜Ÿåˆ—èƒŒå‹ï¼‰ | æ˜¾å¼ï¼ˆæ‰¹æ¬¡çº§åˆ«ï¼‰ |
| **ä»£ç è¡Œæ•°** | ~1500è¡Œ | ~800è¡Œ |
| **å­¦ä¹ æ›²çº¿** | é™¡å³­ | å¹³ç¼“ |
| **æ‰©å±•æ€§** | ä¸­ç­‰ | é«˜ï¼ˆæ˜“äºæ·»åŠ stageï¼‰ |

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | æ—§æ¶æ„ | æ–°æ¶æ„ |
|------|--------|--------|
| **ååé‡** | é«˜ï¼ˆæµå¼å¤„ç†ï¼‰ | ä¸­ï¼ˆæ‰¹å¤„ç†ï¼‰ |
| **å†…å­˜ä½¿ç”¨** | ä¸ç¡®å®šï¼ˆé˜Ÿåˆ—ç§¯å‹ï¼‰ | å¯æ§ï¼ˆæ‰¹æ¬¡å¤§å°ï¼‰ |
| **å¯åŠ¨æ—¶é—´** | æ…¢ï¼ˆåˆå§‹åŒ–å¤æ‚ï¼‰ | å¿«ï¼ˆç®€å•åˆå§‹åŒ–ï¼‰ |
| **æ•…éšœæ¢å¤** | å¤æ‚ï¼ˆcheckpoint+queueï¼‰ | ç®€å•ï¼ˆcheckpointï¼‰ |

**ç»“è®ºï¼š** æ–°æ¶æ„ç‰ºç‰²äº†ä¸€äº›ååé‡ï¼Œæ¢æ¥äº†æ›´å¥½çš„å¯ç»´æŠ¤æ€§å’Œè°ƒè¯•æ€§ã€‚å¯¹äºå¤§éƒ¨åˆ†åœºæ™¯ï¼Œæ–°æ¶æ„çš„ç®€å•æ€§æ›´æœ‰ä»·å€¼ã€‚

---

## ğŸ” æ•…éšœæ’æŸ¥

### 1. å¦‚æœæŸä¸ªstageä¸€ç›´æ²¡æœ‰è¾“å‡º

```bash
# æ£€æŸ¥æ—¥å¿—
tail -f logs/audio_vad_pipeline.log

# å¢åŠ è¯¦ç»†æ—¥å¿—
python run_simple_pipeline.py --log-level DEBUG
```

### 2. å¦‚æœå¤„ç†ä¸­æ–­

```bash
# æŸ¥çœ‹checkpoint
python run_simple_pipeline.py status

# ç›´æ¥ç»§ç»­è¿è¡Œï¼ˆä¼šä»checkpointæ¢å¤ï¼‰
python run_simple_pipeline.py --config config.yaml
```

### 3. å¦‚æœå†…å­˜ä¸è¶³

è°ƒæ•´batch_sizeå’Œworkeræ•°é‡ï¼š
```yaml
pipeline:
  batch_size: 16  # å‡å°æ‰¹æ¬¡å¤§å°
  stage_workers:
    audio_download: 4  # å‡å°‘workeræ•°é‡
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å¼€å‘è°ƒè¯•é˜¶æ®µ
```bash
# ç”¨å°æ‰¹æ¬¡æµ‹è¯•
python run_simple_pipeline.py --max-batches 1 --log-level DEBUG
```

### 2. ç”Ÿäº§ç¯å¢ƒ
```bash
# å…³é—­è¯¦ç»†æ—¥å¿—ï¼Œæé«˜æ€§èƒ½
python run_simple_pipeline.py --config config.yaml --log-level INFO
```

### 3. Workeræ•°é‡é…ç½®åŸåˆ™

- **CPUå¯†é›†å‹** (é¢„å¤„ç†ã€VAD)ï¼šworkeræ•° = CPUæ ¸å¿ƒæ•°
- **IOå¯†é›†å‹** (ä¸‹è½½)ï¼šworkeræ•° = CPUæ ¸å¿ƒæ•° Ã— 2
- **å†…å­˜å¯†é›†å‹** (ç‰‡æ®µå±•å¼€)ï¼šå‡å°‘workeræ•°ï¼Œé¿å…OOM

### 4. ç›‘æ§å…³é”®æŒ‡æ ‡

è¿è¡Œæ—¶å…³æ³¨ï¼š
- æ¯ä¸ªstageçš„å¤„ç†é€Ÿåº¦
- é”™è¯¯ç‡
- å†…å­˜ä½¿ç”¨
- Ray object storeä½¿ç”¨æƒ…å†µ

---

## ğŸ“ æ‰©å±•æ–°Stage

æ·»åŠ æ–°stageéå¸¸ç®€å•ï¼š

```python
# 1. åˆ›å»ºProcessor
class MyNewProcessor(StageProcessor):
    def process(self, batch: ProcessBatch) -> ProcessBatch:
        # å¤„ç†é€»è¾‘
        new_data = []
        for item in batch.data:
            # å¤„ç†item
            new_item = my_process(item)
            new_data.append(new_item)
        
        batch.data = new_data
        return batch

# 2. æ·»åŠ åˆ°Pipeline
pipeline.add_stage(
    stage_class=MyNewProcessor,
    stage_config={'my_param': value},
    stage_name='my_stage',
    num_workers=4
)
```

---

## ğŸ“ æ€»ç»“

æ–°æ¶æ„çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**ç”¨æœ€ç®€å•çš„æ–¹å¼å®ç°åŠŸèƒ½ï¼ŒæŠŠå¤æ‚åº¦ç•™ç»™æˆç†Ÿçš„æ¡†æ¶ï¼ˆRay ActorPoolï¼‰**

ä¼˜åŠ¿ï¼š
âœ… ä»£ç æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
âœ… è°ƒè¯•ç®€å•ï¼Œstep-by-stepå¯è¿½è¸ª
âœ… å®¹é”™å®Œå–„ï¼Œå¤±è´¥é‡è¯•æœºåˆ¶
âœ… æ˜“äºæ‰©å±•ï¼Œæ·»åŠ æ–°stageç®€å•

é€‚ç”¨åœºæ™¯ï¼š
- ä¸­å°è§„æ¨¡æ•°æ®å¤„ç†ï¼ˆ< 1000ä¸‡æ–‡ä»¶ï¼‰
- å¼€å‘æµ‹è¯•é˜¶æ®µ
- éœ€è¦é¢‘ç¹è°ƒè¯•çš„åœºæ™¯
- å›¢é˜ŸæŠ€æœ¯æ°´å¹³ä¸å‡çš„åœºæ™¯

å¦‚æœéœ€è¦æè‡´æ€§èƒ½ï¼ˆæµå¼å¤„ç†ï¼‰ï¼Œå¯ä»¥è€ƒè™‘æ—§æ¶æ„ï¼Œä½†éœ€è¦æŠ•å…¥æ›´å¤šè°ƒè¯•æ—¶é—´ã€‚